# =============================================================================
# Ecossistema Digital — Production Nginx Configuration
# Domain: embaixada-angola.site
# =============================================================================

# --- HTTP → HTTPS redirect ---------------------------------------------------
server {
    listen 80;
    server_name *.embaixada-angola.site embaixada-angola.site;
    return 301 https://$host$request_uri;
}

# --- SGC Frontend (20001) ----------------------------------------------------
server {
    listen 443 ssl http2;
    server_name sgc.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }
}

# --- SI Frontend (20002) -----------------------------------------------------
server {
    listen 443 ssl http2;
    server_name si.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }
}

# --- WN Frontend (20003) -----------------------------------------------------
server {
    listen 443 ssl http2;
    server_name wn.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }
}

# --- GPJ Frontend (20004) ----------------------------------------------------
server {
    listen 443 ssl http2;
    server_name gpj.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20004;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }
}

# --- SGC Backend API (20081) -------------------------------------------------
server {
    listen 443 ssl http2;
    server_name api-sgc.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        client_max_body_size 100m;
    }
}

# --- SI Backend API (20082) --------------------------------------------------
server {
    listen 443 ssl http2;
    server_name api-si.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20082;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        client_max_body_size 100m;
    }
}

# --- WN Backend API (20083) --------------------------------------------------
server {
    listen 443 ssl http2;
    server_name api-wn.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        client_max_body_size 100m;
    }
}

# --- GPJ Backend API (20084) -------------------------------------------------
server {
    listen 443 ssl http2;
    server_name api-gpj.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20084;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        client_max_body_size 100m;
    }
}

# --- Keycloak Auth (20080) — with WebSocket support --------------------------
server {
    listen 443 ssl http2;
    server_name auth.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:20080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# --- Grafana (3000) — with WebSocket support ---------------------------------
server {
    listen 443 ssl http2;
    server_name grafana.embaixada-angola.site;

    ssl_certificate /etc/letsencrypt/live/embaixada-angola.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embaixada-angola.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # OWASP Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
