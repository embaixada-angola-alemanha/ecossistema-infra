# =============================================================================
# Ecossistema Digital — Nginx Reverse Proxy
# =============================================================================

# Upstream definitions (future backends — will 502 until services exist)
upstream sgc_backend  { server host.docker.internal:8081; }
upstream si_backend   { server host.docker.internal:8082; }
upstream wn_backend   { server host.docker.internal:8083; }
upstream gpj_backend  { server host.docker.internal:8084; }

server {
    listen 80;
    server_name localhost;

    # --- OWASP Security Headers ---
    include /etc/nginx/snippets/security-headers.conf;

    # --- Health check endpoint ---
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # --- Keycloak (auth) ---
    location /auth/ {
        proxy_pass http://keycloak:8080/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    location /realms/ {
        proxy_pass http://keycloak:8080/realms/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    location /resources/ {
        proxy_pass http://keycloak:8080/resources/;
        proxy_set_header Host $host;
    }

    location /js/ {
        proxy_pass http://keycloak:8080/js/;
        proxy_set_header Host $host;
    }

    # --- API backends ---
    location /api/sgc/ {
        proxy_pass http://sgc_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/si/ {
        proxy_pass http://si_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/wn/ {
        proxy_pass http://wn_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/gpj/ {
        proxy_pass http://gpj_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- MinIO Storage API ---
    location /storage/ {
        proxy_pass http://minio:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- MinIO Console ---
    location /minio/ {
        proxy_pass http://minio:9001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # --- MailHog UI ---
    location /mail/ {
        proxy_pass http://mailhog:8025/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # --- Landing page ---
    location / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecossistema Digital — Embaixada de Angola</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { max-width: 700px; width: 100%; padding: 2rem; }
        h1 { color: #ce1126; margin-bottom: 0.5rem; font-size: 1.8rem; }
        .subtitle { color: #666; margin-bottom: 2rem; }
        .flag-bar { height: 4px; background: linear-gradient(90deg, #ce1126 50%, #000 50%); margin-bottom: 2rem; border-radius: 2px; }
        .services { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .service { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 1.2rem; transition: border-color 0.2s; }
        .service:hover { border-color: #ce1126; }
        .service a { color: #4da6ff; text-decoration: none; font-weight: 600; display: block; margin-bottom: 0.3rem; }
        .service a:hover { text-decoration: underline; }
        .service small { color: #888; }
        .footer { margin-top: 2rem; text-align: center; color: #555; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ecossistema Digital</h1>
        <p class="subtitle">Embaixada de Angola na Alemanha — Ambiente de Desenvolvimento</p>
        <div class="flag-bar"></div>
        <div class="services">
            <div class="service">
                <a href="http://localhost:8080">Keycloak</a>
                <small>Identity & Access Management</small>
            </div>
            <div class="service">
                <a href="http://localhost:9001">MinIO Console</a>
                <small>Object Storage</small>
            </div>
            <div class="service">
                <a href="http://localhost:8025">MailHog</a>
                <small>Email Testing</small>
            </div>
            <div class="service">
                <a href="http://localhost:6379" onclick="alert(&#39;Redis CLI only — use: redis-cli -p 6379&#39;);return false;">Redis</a>
                <small>Cache (CLI only: port 6379)</small>
            </div>
            <div class="service">
                <a href="http://localhost:5432" onclick="alert(&#39;PostgreSQL — use: psql -h localhost -U ecossistema&#39;);return false;">PostgreSQL</a>
                <small>Database (CLI only: port 5432)</small>
            </div>
            <div class="service">
                <a href="#">Nginx</a>
                <small>Reverse Proxy (this page)</small>
            </div>
        </div>
        <div class="footer">
            <p>Ecossistema Infra v1.0 | T0.1 Docker Compose + Infra</p>
        </div>
    </div>
</body>
</html>';
    }
}
